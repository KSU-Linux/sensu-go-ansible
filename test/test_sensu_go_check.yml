- hosts: localhost
  gather_facts: false
  collections:
    - flowerysong.sensu_go
  module_defaults:
    group/sensu_go:
      url: "http://localhost:{{ sensu_port }}/"
  tasks:
    - name: Create a check
      sensu_go_check:
        name: check
        command: /bin/true
        subscriptions:
          - checks
          - also_checks
        handlers:
          - default
          - not_default
      register: result

    - assert:
        that: result is changed

    - name: Test check creation idempotence
      sensu_go_check:
        name: check
        command: /bin/true
        subscriptions:
          - checks
          - also_checks
        handlers:
          - default
          - not_default
      register: result

    - assert:
        that: result is not changed

    - name: Create a second check
      sensu_go_check:
        name: check2
        command: /usr/bin/true
        subscriptions: checks
        handlers: default

    - name: Test getting all checks
      sensu_go_check_info:

    - name: Test getting specific check
      sensu_go_check_info:
        name: check
      register: result

    - assert:
        that:
          - result.checks | length == 1
          - result.checks.0.metadata.name == 'check'
